<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Telegram Notifier</title>
</head>

<body>
    <div id="TelegramNotifierConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
        data-require="emby-input,emby-button,emby-select,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="TelegramNotifierConfigForm">
                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="EnablePlugin" name="EnablePluginCheckBox" type="checkbox" is="emby-checkbox" />
                            <span>Enable Plugin</span>
                        </label>
                    </div>
                    <div class="label">You can find a guide in the "Use the plugin" section of the <a
                            href="https://github.com/RomainPierre7/jellyfin-plugin-TelegramNotifier"
                            target="_blank">README.md</a> file of the project.
                    </div>
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2>Telegram Bot Configuration</h2>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="BotToken">Bot token</label>
                        <input id="BotToken" name="BotToken" type="text" is="emby-input" />
                        <div class="fieldDescription">Insert your telegram bot token here. </div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel inputLabelUnfocused" for="ChatId">Chat ID</label>
                        <input id="ChatId" name="ChatId" type="text" is="emby-input" />
                        <div class="fieldDescription"> Insert your telegram chat id here. </div>
                        <div>
                            <button id="testButton" is="emby-button" class="raised button block emby-button">
                                <span>Test bot configuration</span>
                            </button>
                        </div>
                        <div>
                            <button id="saveButton" is="emby-button" type="submit"
                                class="raised button-submit block emby-button">
                                <span>Save</span>
                            </button>
                        </div>
                </form>
            </div>
        </div>
        <script type="text/javascript">
            var TelegramNotifierConfig = {
                pluginUniqueId: 'fd76211d-17e0-4a72-a23f-c6eeb1e48b3a'
            };

            document.querySelector('#TelegramNotifierConfigPage')
                .addEventListener('pageshow', function () {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(TelegramNotifierConfig.pluginUniqueId).then(function (config) {
                        document.querySelector('#EnablePlugin').checked = config.EnablePlugin;
                        document.querySelector('#BotToken').value = config.BotToken;
                        document.querySelector('#ChatId').value = config.ChatId;
                        Dashboard.hideLoadingMsg();
                    });
                });

            document.querySelector('#TelegramNotifierConfigForm')
                .addEventListener('submit', function (e) {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(TelegramNotifierConfig.pluginUniqueId).then(function (config) {
                        config.EnablePlugin = document.querySelector('#EnablePlugin').checked;
                        config.BotToken = document.querySelector('#BotToken').value;
                        config.ChatId = document.querySelector('#ChatId').value;
                        ApiClient.updatePluginConfiguration(TelegramNotifierConfig.pluginUniqueId, config).then(function (result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });

                    e.preventDefault();
                    return false;
                });

            document.getElementById('testButton').addEventListener('click', function () {
                var button = this;
                button.disabled = true;

                ApiClient.getPluginConfiguration(TelegramNotifierConfig.pluginUniqueId)
                    .then(function (config) {
                        Dashboard.showLoadingMsg();
                        config.BotToken = document.querySelector('#BotToken').value;
                        config.ChatId = document.querySelector('#ChatId').value;
                        return ApiClient.updatePluginConfiguration(TelegramNotifierConfig.pluginUniqueId, config);
                    })
                    .then(function () {
                        return fetch('/TelegramNotifierApi/TestNotifier');
                    })
                    .then(function (response) {
                        Dashboard.hideLoadingMsg();
                        if (!response.ok) {
                            throw new Error('Error while sending the test message to the telegram bot');
                        }
                        button.style.backgroundColor = 'green';
                        button.textContent = 'Test passed';
                    })
                    .catch(function (error) {
                        button.style.backgroundColor = 'red';
                        button.textContent = 'Test failed';
                    })
                    .finally(function () {
                        setTimeout(function () {
                            button.disabled = false;
                            button.style.backgroundColor = '';
                            button.textContent = 'Test bot configuration';
                        }, 2000);
                    });
            });
        </script>
    </div>
</body>

</html>